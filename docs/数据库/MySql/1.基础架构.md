# 基础架构

一个sql语句在mysql中的执行流程
1. Client发送sql语句
2. 连接器：管理连接，进行权限校验
3. 查询缓存：命中缓存，直接返回
4. 分析器：词法分析，语法分析
5. 优化器：执行计划生产，索引选择
6. 执行器：操作引擎，返回结果
7. 存储引擎：存储数据，提供读写接口

## MySQL基础架构
1. Server层
  - 连接器
  - 查询缓存
  - 分析器：知道了要做什么
  - 优化器：直到了要怎么做
  - 执行器：去按照计划做
2. 存储引擎层
  - InnoDB
  - MyISAM

## 连接器

连接器负责根用户端建立连接，获取权限，维持和管理连接。

1. 客户端通过连接命令和服务端建立连接，在完成经典的TCP握手后
2. 连接器开始认证身份（用户名和密码），认证通过后
3. 会到权限表里查出你拥有的权限（需要权限时，读取的都是这时候查到的权限），意味着即使管理员修改了你的权限，已经建立连接的客户端权限不会马上改变
4. 建立连接后，该连接处于空闲状态（show processlist），客户端太长时间没动静，会自动断开（wait_timeout参数控制，默认8小时）
5. 建立长连接后，有时候会发现内存暴涨，是由于mysql在执行过程中临时使用的内存是管理在连接对象里的，在断开连接时才释放。累计起来，就会OOM，就是MySQL异常重启。
  - 定期断开长连接。
  - 每次执行一个比较大的操作后，执行mysql_reset_connection重新初始化连接资源，不会重新连接，但会初始化连接到刚创建完的状态。

## 查询缓存

进行查询时，会先到查询缓存进行查询，sql语句为key，查询结果为value，被直接命中的话，直接返回结果。如果未命中，执行查询后，会将结果放到缓存中，提高效率。

多数情况下，不建议使用查询缓存，因为失效太频繁。

MySQL8.0直接将查询缓存整块删掉了，没有这个功能了。

## 分析器

真正开始执行sql语句，首先要直到做什么，所以对sql语句进行解析。

先做词法分析，对每一个词进行分析。

再做语法分析，根据词法分析的结果，语法分析根据语法规则，判断你输入的sql是否满足语法规则。

## 优化器

经过分析器，mysql就直到你要做什么了，在开始执行前，要先经过优化器的处理。

优化器的作用：
1. 在表里有多个索引时，决定用哪个索引
2. 或者一个多表关联查询时，决定连接的顺序。

经过优化器后，sql语句的执行方案就确定下来了，然后进入执行器阶段。

## 执行器

sql进入执行器开始执行。

1. 先判断对表是否有查询的权限（如果命中缓存，会在返回结果的时候，做权限校验）
2. 有权限，打开表，根据表定义的引擎，去使用引擎提供的接口

## 一条更新语句的执行流程
1. 连接器连接mysql，发送更新语句；
2. 查询缓存：清空这张表的所有缓存
3. 分析器：分析词法，语法，获得sql目的
4. 优化器：决定使用ID这个索引进行更新
5. 执行器：负责具体执行，找到这一行，然后更新

## 更新还涉及两个日志：redo log（重做日志）和binlog（归档日志）

binlog是Server层的日志，记录sql语句，redo log是InnoDB存储引擎的，记录在数据页上修改了什么数据。

当一条记录需要被更新的时候，InnoDB会先把记录写到redolog里面，并更新内存，这个时候就算写完了。InnoDB在适当的时候，会把记录记到磁盘。

## 两阶段提交

为了让两份数据之间的逻辑一致。