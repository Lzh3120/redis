 # 虚拟内存

 ## 物理和虚拟寻址

>计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每个字节都有一个唯一的物理地址。CPU访问内存最开始就是使用物理地址，称为物理寻址。

> 现代处理使用虚拟寻址的方式，CPU通过生成一个虚拟地址（Virtual Address VA）访问**主存**，虚拟地址被送到主存之前先转换成适当的物理地址。过程叫做地址翻译，通过CPU芯片上的**内存管理单元**（Memory Management Unit）MMU的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表由内容由操作系统管理。

**地址空间**是一个非负整数地址的有序集合，若果是连续的，称为线性地址空间。
**虚拟地址空间**是带虚拟内存的系统的CPU从一个有2的n次个地址的地址空间中生成虚拟地址，称为虚拟地址空间。

> 主存中的每字节都有一个选自虚拟内存空间的虚拟地址和一个选自物理地址空间的物理地址。

## 虚拟内存作为缓存的工具

磁盘上的数组的内容被缓存在主存中，磁盘上的数据被分割为块，作为磁盘和主存之间的传输单元。
VM系统通过将虚拟内存分割为虚拟页的大小固定的块来处理。类似的，物理内存被分割为物理页，也称为页帧。

虚拟页面的集合分为三个不相交的子集：
1. 未分配的：VM系统未分配的页，没有任何数据，不占用磁盘空间。
2. 缓存的：已缓存在物理内存中的已分配的页。
3. 未缓存的：未缓存在物理内存中的已分配页。

## DRAM缓存的组织结构

SRAM缓存：位于CPU和主存之间的L1，Ｌ2，L3高速缓存。

DRAM缓存：虚拟内存系统的缓存，在主存缓存虚拟页。

DRAM对磁盘的访问时间很长，所以缓存总是使用写回，而不是直写。

## 页表

页表：存放在物理内存中，将虚拟内存映射到物理页。每次虚拟地址转换物理地址时都查询页表，操作系统维护页表，以及磁盘与DRAM之间的传送页。

## 页命中

CPU从页表中读取页时，标记为有效的页面为命中，转换为物理地址，进行读取。

## 缺页

DRAM缓存不命中称为缺页，当CPU访问一个未被缓存的页时，触发缺页异常，缺页异常调用内核中的缺页异常处理程序，会选择一个牺牲页（牺牲页被复制回磁盘），内核从磁盘中复制缺的页到主存，更新页表。然后重新启动导致缺页的指令，该指令把导致缺页的虚拟地址重新发回地址翻译硬件。

虚拟内存的习惯：块被称为页，磁盘和内存之间传送页的活动叫交换或页面调度。页从磁盘换入DRAM，和从DRAM换出磁盘。一直等待，当有不命中发生时，才换入页面的这种策略，称为按需页面调度。

## 分配页面

调用malloc时，在磁盘上创建空间并更新页表对应页表条目，使它指向磁盘上这个新创建的页面。


## 虚拟内存作为内存管理的工具

虚拟内存简化了内存管理，并提供了自然的保护内存的方法。

操作系统为每个进程提供了一个独立的页表，因此就是一个独立的虚拟地址空间。多个虚拟页面可以映射到同一个共享的物理页面上。

按需页面加载和独立的虚拟地址空间，简化了链接和加载，代码和数据共享，以及应用程序的内存分配。

1. 简化链接
2. 简化加载
3. 简化共享
4. 简化内存分配

## 虚拟内存作为内存保护的工具

CPU生成一个地址时，地址翻译都会访问页表条目，通过在页表条目PTE添加许可控制对一个虚拟页面的访问。

1. SUP：表示进程是否必须运行在内核模式下。
2. READ：控制页面写
3. WRETE：控制页面读

如果一条指令违反了这些许可，CPU会触发一个一般保护故障，将控制传递给一个内核中的异常处理程序。

## 地址翻译

## 多级页表

## 垃圾收集器

